# 02. 기술 아키텍처 (Technical Architecture)

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        Local Chat PWA                          │
├─────────────────────────────────────────────────────────────────┤
│                    Frontend Layer                              │
│  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────┐   │
│  │   Next.js   │  │     React       │  │   TypeScript    │   │
│  │   App Router│  │   Components    │  │   Type Safety   │   │
│  │   PWA       │  │   Hooks         │  │   Interfaces    │   │
│  └─────────────┘  └─────────────────┘  └─────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                    UI/UX Layer                                 │
│  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────┐   │
│  │  Tailwind   │  │   ShadCN UI     │  │   Lucide Icons  │   │
│  │     CSS     │  │   Components    │  │   SVG Icons     │   │
│  │  Styling    │  │   Design System │  │   Visual Assets │   │
│  └─────────────┘  └─────────────────┘  └─────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                    State Management                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              React Hooks + Context                     │   │
│  │                                                         │   │
│  │ • useLocalChat() - 기본 채팅 로직                      │   │
│  │ • useEnhancedChat() - 다중 세션 관리                   │   │
│  │ • useState() - 로컬 상태 관리                          │   │
│  │ • useCallback() - 성능 최적화                          │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                    Data Storage Layer                          │
│  ┌─────────────┐  ┌─────────────────┐  ┌─────────────────┐   │
│  │  IndexedDB  │  │  localStorage   │  │   Cache API     │   │
│  │             │  │                 │  │                 │   │
│  │ • Messages  │  │ • Settings      │  │ • PWA Assets    │   │
│  │ • Chats     │  │ • Preferences   │  │ • Offline Data  │   │
│  │ • Metadata  │  │ • UI State      │  │ • Model Cache   │   │
│  └─────────────┘  └─────────────────┘  └─────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                    AI Engine Layer                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              MLC-AI Web-LLM                            │   │
│  │                                                         │   │
│  │ • Model Loading & Initialization                       │   │
│  │ • Real-time Inference Engine                           │   │
│  │ • Streaming Response Generation                         │   │
│  │ • Browser-based AI Processing                          │   │
│  │ • WebAssembly Optimization                             │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 컴포넌트 아키텍처

### 핵심 컴포넌트 구조

```
src/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # 루트 레이아웃 (PWA 등록)
│   ├── page.tsx                 # 메인 페이지
│   └── globals.css              # 전역 스타일
├── components/                   # React 컴포넌트
│   ├── chat/                    # 채팅 관련 컴포넌트
│   │   ├── index.tsx            # 메인 채팅 컴포넌트
│   │   ├── chat-messages.tsx    # 메시지 표시 컴포넌트
│   │   └── chat-input.tsx       # 입력 컴포넌트
│   ├── ui/                      # 재사용 가능한 UI 컴포넌트
│   │   └── button.tsx           # 버튼 컴포넌트
│   ├── enhanced-chat.tsx        # 향상된 채팅 컴포넌트
│   ├── settings.tsx             # 설정 패널
│   └── enhanced-sidebar.tsx     # 향상된 사이드바
├── hooks/                       # 커스텀 React 훅
│   ├── use-local-chat.ts        # 기본 채팅 로직
│   └── use-enhanced-chat.ts    # 다중 세션 지원
└── lib/                         # 유틸리티 및 라이브러리
    ├── db.ts                    # IndexedDB 관리
    └── utils.ts                 # 유틸리티 함수
```

### 데이터 플로우 다이어그램

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │    │   React     │    │   MLC-AI    │
│  Input      │───▶│  Component  │───▶│  Web-LLM    │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │                   ▼                   ▼
       │            ┌─────────────┐    ┌─────────────┐
       │            │   State     │    │   Model     │
       │            │ Management  │    │ Processing  │
       │            └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   UI        │    │ IndexedDB   │    │ Streaming   │
│  Update     │◀───│  Storage    │◀───│  Response   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 핵심 기술 상세

### 1. MLC-AI Web-LLM 통합

```typescript
// src/hooks/use-local-chat.ts
const initializeEngine = useCallback(async () => {
  const { CreateMLCEngine } = await import('@mlc-ai/web-llm')
  
  const MODEL_ID = 'Llama-3.1-8B-Instruct-q4f32_1-MLC'
  
  engineRef.current = await CreateMLCEngine(MODEL_ID, {
    initProgressCallback: (progress) => {
      setState(prev => ({ 
        ...prev, 
        modelStatus: progress.text 
      }))
    }
  })
}, [])
```

**주요 특징:**
- 동적 임포트로 SSR 호환성 확보
- 진행률 콜백으로 사용자 피드백 제공
- WebAssembly 기반 고성능 추론
- 브라우저 메모리에서 직접 실행

### 2. IndexedDB 데이터 관리

```typescript
// src/lib/db.ts
class LocalDatabase {
  async init(): Promise<void> {
    const request = indexedDB.open(DB_NAME, DB_VERSION)
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result
      
      // 대화 저장소 생성
      if (!db.objectStoreNames.contains(CONVERSATIONS_STORE)) {
        const store = db.createObjectStore(CONVERSATIONS_STORE, { keyPath: 'id' })
        store.createIndex('createdAt', 'createdAt', { unique: false })
      }
      
      // 메시지 저장소 생성
      if (!db.objectStoreNames.contains(MESSAGES_STORE)) {
        const store = db.createObjectStore(MESSAGES_STORE, { keyPath: 'id' })
        store.createIndex('conversationId', 'conversationId', { unique: false })
      }
    }
  }
}
```

**주요 특징:**
- 스키마 버전 관리
- 인덱싱으로 빠른 검색
- 트랜잭션 기반 데이터 무결성
- 대용량 데이터 효율적 처리

### 3. PWA 구현

```javascript
// public/sw.js
const CACHE_NAME = 'local-chat-v1'
const urlsToCache = ['/', '/manifest.json']

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(urlsToCache))
  )
})

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => response || fetch(event.request))
  )
})
```

**주요 특징:**
- 오프라인 캐싱 지원
- 네이티브 앱 설치 가능
- 백그라운드 동기화
- 푸시 알림 준비

## 성능 최적화 전략

### 1. 메모리 관리
- 모델 로딩 시 메모리 사용량 모니터링
- 불필요한 컴포넌트 언마운트 시 메모리 해제
- 가비지 컬렉션 최적화

### 2. 렌더링 최적화
- React.memo로 불필요한 리렌더링 방지
- useCallback과 useMemo로 함수/값 메모이제이션
- 가상화된 리스트로 대용량 메시지 처리

### 3. 데이터 최적화
- IndexedDB 인덱싱으로 빠른 검색
- 페이지네이션으로 대용량 데이터 처리
- 압축된 모델 파일 사용

## 보안 고려사항

### 1. 로컬 데이터 보안
- 모든 데이터가 사용자 기기에만 저장
- 브라우저 보안 정책 준수
- 민감한 정보 암호화 (향후 구현)

### 2. AI 모델 보안
- 로컬에서만 추론 실행
- 네트워크 전송 없음
- 사용자 데이터 외부 전송 없음

## 확장성 설계

### 1. 모듈화된 구조
- 컴포넌트별 독립적 개발 가능
- 플러그인 방식의 기능 확장
- 마이크로프론트엔드 준비

### 2. API 설계
- RESTful API 준비 (향후 클라우드 연동)
- GraphQL 스키마 설계
- WebSocket 실시간 통신 준비

### 3. 데이터베이스 설계
- 마이그레이션 시스템
- 백업 및 복원 기능
- 데이터 버전 관리 